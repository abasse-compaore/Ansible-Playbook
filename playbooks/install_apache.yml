---
- name: Installation complète d'Apache sur Ubuntu 24.04
  hosts: all
  become: yes

  tasks:
    - name: Remove Apache if partially installed
      apt:
        name: apache2
        state: absent
        purge: yes
        autoremove: yes
      ignore_errors: yes

    - name: Clean apt cache
      apt:
        autoclean: yes

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Apache avec dépendances
      apt:
        name:
          - apache2
          - apache2-utils
          - apache2-bin
        state: latest

    - name: Check service file
      stat:
        path: /lib/systemd/system/apache2.service
      register: service_file

    - name: Debug service file
      debug:
        var: service_file.stat.exists

    - name: Create service file if missing (fallback)
      block:
        - name: Create basic apache2 service
          copy:
            dest: /lib/systemd/system/apache2.service
            content: |
              [Unit]
              Description=The Apache HTTP Server
              After=network.target

              [Service]
              Type=forking
              ExecStart=/usr/sbin/apachectl start
              ExecStop=/usr/sbin/apachectl stop
              ExecReload=/usr/sbin/apachectl graceful
              Restart=on-abort

              [Install]
              WantedBy=multi-user.target
          when: not service_file.stat.exists

        - name: Reload systemd
          systemd:
            daemon_reload: yes
          when: not service_file.stat.exists
      when: not service_file.stat.exists

    - name: Start and enable Apache
      systemd:
        name: apache2
        state: started
        enabled: yes

    - name: Verify Apache installation
      shell: |
        curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "Failed"
      register: http_check
      changed_when: false
      ignore_errors: yes

    - name: Show verification result
      debug:
        msg: "Apache HTTP response: {{ http_check.stdout }}"